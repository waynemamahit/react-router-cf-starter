pipelines:
  branches:
    main:
      - step:
          name: Deploy Cloudflare Worker to Production
          caches:
            - node
          script:
            - npm install -g pnpm
            - pnpm install

            # Build & Deploy
            - pnpm build

            # Inject placeholders via script (map repo vars -> unprefixed env vars)
            - export VALUE_FROM_CLOUDFLARE="$PRODUCTION_VALUE_FROM_CLOUDFLARE"
            - export KV_ID="$PRODUCTION_KV_ID"
            - export D1_DB_ID="$PRODUCTION_D1_DB_ID"
            - export HYPERDRIVE_DB_ID="$PRODUCTION_HYPERDRIVE_DB_ID"
            - export VECTORIZE_INDEX_NAME="$PRODUCTION_VECTORIZE_INDEX_NAME"
            - node scripts/inject-env.js production
            - CLOUDFLARE_API_TOKEN="$CLOUDFLARE_API_TOKEN" pnpm exec wrangler deploy
    dev:
      - step:
          name: Deploy Cloudflare Worker to Staging
          caches:
            - node
          script:
            - npm install -g pnpm
            - pnpm install

            # Build & Deploy
            - pnpm build

            # Inject placeholders via script (map repo vars -> unprefixed env vars)
            - export VALUE_FROM_CLOUDFLARE="$STAGING_VALUE_FROM_CLOUDFLARE"
            - export KV_ID="$STAGING_KV_ID"
            - export D1_DB_ID="$STAGING_D1_DB_ID"
            - export HYPERDRIVE_DB_ID="$STAGING_HYPERDRIVE_DB_ID"
            - export VECTORIZE_INDEX_NAME="$STAGING_VECTORIZE_INDEX_NAME"
            - node scripts/inject-env.js staging
            - CLOUDFLARE_API_TOKEN="$CLOUDFLARE_API_TOKEN" pnpm exec wrangler deploy
